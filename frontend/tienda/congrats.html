<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Gracias por tu compra</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <base href="/tienda/">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://js.stripe.com/v3/"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>

<body class="bg-[#0F172A] text-white flex items-center justify-center min-h-screen p-6">

  <div class="max-w-lg w-full bg-[#1E293B] p-8 rounded-2xl text-center shadow-xl">
    <!-- Estado cargando -->
    <div id="loading" class="animate-pulse">
      <div class="w-12 h-12 mx-auto mb-4 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
      <p class="text-gray-300">Verificando tu pago...</p>
    </div>

    <!-- √âxito -->
    <div id="success" class="hidden">
      <div class="w-20 h-20 mx-auto mb-6 flex items-center justify-center bg-green-600 rounded-full text-4xl shadow-lg">
        ‚úÖ
      </div>
      <h1 class="text-3xl font-bold mb-3 text-green-400">¬°Gracias por tu compra!</h1>
      <p class="text-gray-300 mb-4">Tu pago se proces√≥ correctamente.</p>
      
      <div class="bg-[#334155] rounded-lg p-4 mb-6 text-left">
        <div class="flex justify-between items-center mb-2">
          <span class="text-gray-400 text-sm">N√∫mero de orden:</span>
          <span id="order-number" class="font-mono font-semibold text-blue-400"></span>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-gray-400 text-sm">ID de transacci√≥n:</span>
          <span id="payment-id" class="font-mono text-xs text-gray-300"></span>
        </div>
      </div>

      <p class="text-sm text-gray-400 mb-6">
        Recibir√°s un correo de confirmaci√≥n con los detalles de tu compra.
      </p>

      <div class="space-y-3">
        <a href="/tienda#productos-container"
          class="block bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg text-white font-medium transition-colors">
          Volver a la tienda
        </a>
        <a href="/tienda/mis-pedidos.html"
          class="block bg-gray-600 hover:bg-gray-700 px-6 py-3 rounded-lg text-white font-medium transition-colors">
          Ver mis pedidos
        </a>
      </div>
    </div>

    <!-- Procesando -->
    <div id="processing" class="hidden">
      <div class="w-16 h-16 mx-auto mb-4 border-4 border-yellow-400 border-t-transparent rounded-full animate-spin">
      </div>
      <h1 class="text-xl font-semibold mb-2 text-yellow-400">Tu pago est√° en proceso</h1>
      <p class="text-gray-300 mb-4">Esto puede tardar unos minutos. Te notificaremos una vez se confirme.</p>
      <p class="text-sm text-gray-500">Puedes cerrar esta ventana de forma segura.</p>
    </div>

    <!-- Error -->
    <div id="error" class="hidden">
      <div class="w-16 h-16 mx-auto mb-4 flex items-center justify-center bg-red-600 rounded-full text-2xl">
        ‚ùå
      </div>
      <h1 class="text-2xl font-semibold mb-2 text-red-400">Hubo un problema con tu pago</h1>
      <p id="error-message" class="text-gray-300 mb-6"></p>
      
      <div class="space-y-3">
        <a href="/tienda/checkout.html" 
          class="block bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg text-white font-medium transition-colors">
          Intentar nuevamente
        </a>
        <a href="/tienda#productos-container" 
          class="block bg-gray-600 hover:bg-gray-700 px-6 py-3 rounded-lg text-white font-medium transition-colors">
          Volver a la tienda
        </a>
      </div>
    </div>
  </div>

  <script>
    const stripe = Stripe('pk_test_51SJ0SkQgvgdQqQVEfityZf2aMvcdyEZaqWfrUl0AW8XCJKuZhRxnidAl31RMNumHjsDRS1dznNk3xnIhhnWdfVS000ZqN8BajB');

    const loadingEl = document.getElementById('loading');
    const successEl = document.getElementById('success');
    const errorEl = document.getElementById('error');
    const processingEl = document.getElementById('processing');
    const errorMessageEl = document.getElementById('error-message');
    const orderNumberEl = document.getElementById('order-number');
    const paymentIdEl = document.getElementById('payment-id');

    async function checkPayment() {
      const urlParams = new URLSearchParams(window.location.search);
      const clientSecret = urlParams.get('payment_intent_client_secret');
      const orderNumber = urlParams.get('order_number');

      console.log('üîç Verificando pago...');
      console.log('Client Secret:', clientSecret ? 'Presente' : 'Ausente');
      console.log('Order Number:', orderNumber || 'No proporcionado');

      if (!clientSecret) {
        showError('No se encontr√≥ informaci√≥n del pago. Si realizaste un pago, contacta a soporte.');
        return;
      }

      try {
        const { paymentIntent, error } = await stripe.retrievePaymentIntent(clientSecret);

        loadingEl.classList.add('hidden');

        if (error) {
          console.error('‚ùå Error de Stripe:', error);
          showError(error.message);
          return;
        }

        console.log('‚úÖ Payment Intent Status:', paymentIntent.status);

        switch (paymentIntent.status) {
          case 'succeeded':
            successEl.classList.remove('hidden');
            if (orderNumber) {
              orderNumberEl.textContent = orderNumber;
            } else {
              orderNumberEl.textContent = 'Procesando...';
            }
            paymentIdEl.textContent = paymentIntent.id;
            console.log('üéâ Pago exitoso');
            break;

          case 'processing':
            processingEl.classList.remove('hidden');
            console.log('‚è≥ Pago en proceso');
            break;

          case 'requires_payment_method':
            showError('El pago no se pudo completar. Por favor, intenta con otro m√©todo de pago.');
            break;

          case 'requires_action':
            showError('Se requiere una acci√≥n adicional para completar el pago. Por favor, verifica tu email o banco.');
            break;

          default:
            showError(`Estado del pago: ${paymentIntent.status}. Por favor, contacta a soporte si el cargo fue realizado.`);
            console.warn('‚ö†Ô∏è Estado inesperado:', paymentIntent.status);
        }
      } catch (err) {
        console.error('‚ùå Error verificando pago:', err);
        showError('Error al verificar el pago. Por favor, verifica tu email de confirmaci√≥n o contacta a soporte.');
      }
    }

    function showError(message) {
      loadingEl.classList.add('hidden');
      errorEl.classList.remove('hidden');
      errorMessageEl.textContent = message;
    }

    // Iniciar verificaci√≥n
    checkPayment();
  </script>

</body>

</html>